default_platform(:android)

platform :android do
  desc 'Prepare keystore from base64 secret and build AAB + upload to Play Store internal track'
  lane :beta do
    sh("if [ -n \"$ANDROID_KEYSTORE_BASE64\" ]; then mkdir -p android/app && echo \"$ANDROID_KEYSTORE_BASE64\" | base64 --decode > android/app/keystore.jks; fi")
    gradle(task: 'bundleRelease')
    upload_to_play_store(track: 'internal', json_key: ENV['PLAY_SERVICE_ACCOUNT_JSON'])
  end

  desc 'Prepare keystore and upload release to Play Store'
  lane :release do
    sh("if [ -n \"$ANDROID_KEYSTORE_BASE64\" ]; then mkdir -p android/app && echo \"$ANDROID_KEYSTORE_BASE64\" | base64 --decode > android/app/keystore.jks; fi")
    gradle(task: 'bundleRelease')
    upload_to_play_store(track: 'production', json_key: ENV['PLAY_SERVICE_ACCOUNT_JSON'])
  end
end

platform :ios do
  desc 'Build and upload to TestFlight (requires APP_STORE_CONNECT_API_KEY secret)'
  lane :beta do
    if ENV['APP_STORE_CONNECT_API_KEY']
      api_key = app_store_connect_api_key(path: ".app_store_connect_api_key.json")
      sh("echo \"$APP_STORE_CONNECT_API_KEY\" > .app_store_connect_api_key.json")
    end
    build_app(scheme: 'Runner')
    upload_to_testflight
  end

  desc 'Release to App Store'
  lane :release do
    if ENV['APP_STORE_CONNECT_API_KEY']
      sh("echo \"$APP_STORE_CONNECT_API_KEY\" > .app_store_connect_api_key.json")
    end
    capture_screenshots
    build_app(scheme: 'Runner')
    deliver(force: true)
  end
end
